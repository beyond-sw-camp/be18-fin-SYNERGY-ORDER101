version: 0.2
phases:
  install:
    commands:
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$REPOSITORY_NAME
      - echo Preparing CodeBuild environment...

  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      # ECR ë¡œê·¸ì¸ (AWS ê³„ì • IDì™€ ë¦¬ì „ì€ CodeBuild í™˜ê²½ ë³€ìˆ˜ë¡œ ìë™ ì£¼ì…ë¨)
      - AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
  
  build:
    commands:
      # ECR ì €ì¥ì†Œ URI ì •ì˜
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/five-team-backend-repo # ğŸš¨ 1. ECR ì €ì¥ì†Œ ì´ë¦„ìœ¼ë¡œ ìˆ˜ì •
      - IMAGE_TAG=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      
      # 1. Maven ë¹Œë“œëŠ” Dockerfile ë‚´ì—ì„œ ìˆ˜í–‰ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” Docker buildë§Œ ì‹¤í–‰
      - echo Building the Docker image...
      # Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë¹Œë“œ
      - docker build -t $REPOSITORY_URI:latest .
      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
      
      # 2. ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
      - echo Pushing the Docker images...
      - docker push $REPOSITORY_URI:latest
      - docker push $REPOSITORY_URI:$IMAGE_TAG

  post_build:
    commands:
      - echo Creating imagedefinitions.json for ECS deployment...
      # ECSì— ë°°í¬í•  ì´ë¯¸ì§€ ì •ë³´ë¥¼ ë‹´ì€ JSON íŒŒì¼ ìƒì„± (ë¬´ì¤‘ë‹¨ ë°°í¬ì˜ í•µì‹¬ ì •ë³´)
      # name: synergy-order101-backendëŠ” ECS Task Definitionì˜ ì»¨í…Œì´ë„ˆ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
      - printf '[{"name":"synergy-order101-backend","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json

artifacts:
  files:
    - imagedefinitions.json # CodePipelineì˜ ë‹¤ìŒ ë‹¨ê³„(ECS ë°°í¬)ë¡œ ì „ë‹¬ë  ìµœì¢… ê²°ê³¼ë¬¼