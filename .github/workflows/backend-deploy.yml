 name: Backend Deploy (Maven)
    
 on:
  push:
    branches: [ "develop" ]
 
  jobs:
    build-and-deploy:
      runs-on: ubuntu-latest
      # OIDC를 사용하기 위해 필수! 워크플로우에 ID 토큰 발급 권한 부여
      permissions:
        id-token: write
        contents: read

      steps:
        # 1. 코드를 Runner로 다운로드
       - name: Checkout code
         uses: actions/checkout@v3

       # 2. JDK 17 환경 설정
       - name: Set up JDK 17
         uses: actions/setup-java@v3
         with:
           java-version: '17'
           distribution: 'temurin'
           cache: 'maven' # Maven 의존성 캐싱으로 빌드 속도 향상

       # 3. Maven으로 프로젝트 빌드 (테스트 포함, 패키징)
       - name: Build with Maven
         run: mvn -B package --file pom.xml

       # 4. 배포 패키지 생성 (target 폴더의 jar 파일을 zip으로 압축)
       - name: Generate deployment package
         run: |
           mkdir -p deploy
           cp target/*.jar deploy/application.jar
           cd deploy && zip -r deploy.zip .
 
       # 5. AWS 자격 증명 설정 (OIDC 역할 사용)
       - name: Configure AWS credentials
         uses: aws-actions/configure-aws-credentials@v4
         with:
           role-to-assume: arn:aws:iam::123456789012:role/github-actions-backend-deploy-role # 1단계에서
      복사한 역할 ARN
           aws-region: ap-northeast-2
       # 6. Elastic Beanstalk에 배포
       - name: Deploy to Elastic Beanstalk
         uses: einaregilsson/beanstalk-deploy@v21
         with:
           application_name: "your-backend-app-name"
           environment_name: "your-backend-env-name"
           version_label: "v-${{ github.sha }}"
           region: ap-northeast-2
           deployment_package: deploy/deploy.zip